
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Get user data from their token claims
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user is a 'super_admin'
    function isSuperAdmin() {
      return getUserData().role == 'super_admin';
    }
    
    // Check if user belongs to the specified tenant
    function isTenantMember(tenantId) {
      return getUserData().tenantId == tenantId;
    }
    
    // Check if user has 'admin' role within their tenant
    function isTenantAdmin(tenantId) {
      return isTenantMember(tenantId) && getUserData().role == 'admin';
    }

    // Users collection: Simple rules for user profile management
    match /users/{userId} {
      // Users can create their own user doc upon signup
      allow create: if request.auth != null;
      // Users can only read/write their own user document
      allow read, update: if request.auth.uid == userId || isSuperAdmin();
    }
    
    // Tenants collection: The root for all tenant-specific data
    match /tenants/{tenantId} {
      // Only super admins can create or delete entire tenants
      allow create, delete: if isSuperAdmin();
      
      // Tenant members can read their own tenant doc, but only super admins can update subscription details etc.
      allow read: if isTenantMember(tenantId);
      allow update: if isSuperAdmin();

      // All sub-collections within a tenant require the user to be a member of that tenant
      match /{subcollection}/{docId} {
        allow read, write: if isTenantMember(tenantId);
      }
      
      // Specific rules for proposals sub-collection
      match /proposals/{proposalId} {
        // Any tenant member can read any proposal within their tenant
        allow read: if isTenantMember(tenantId);
        
        // Creating proposals is allowed for tenant members
        allow create: if isTenantMember(tenantId);
        
        // Updates are more complex:
        // - A sales agent can update a proposal they own.
        // - A client can update (e.g., to accept or suggest changes) if they are the client on the proposal.
        // - A tenant admin can update any proposal in their tenant.
        allow update: if isTenantMember(tenantId) && 
                         (resource.data.salesAgentId == request.auth.uid || 
                          isTenantAdmin(tenantId) ||
                          resource.data.clientId == getUserData().uid); // Assuming client user's UID is used as ID on proposal
        
        // Deleting proposals is restricted to tenant admins or the sales agent who owns it.
        allow delete: if isTenantMember(tenantId) &&
                         (resource.data.salesAgentId == request.auth.uid ||
                          isTenantAdmin(tenantId));
      }

      // Rules for sub-sub-collections like comments, versions etc.
      match /proposals/{proposalId}/{subcollection}/{docId} {
         allow read, write: if isTenantMember(tenantId);
      }

      // Rules for product catalog, rules, etc.
      // Admins can write, members can only read
      match /products/{productId} {
          allow read: if isTenantMember(tenantId);
          allow write: if isTenantAdmin(tenantId);
      }
      
      match /product_rules/{ruleId} {
          allow read: if isTenantMember(tenantId);
          allow write: if isTenantAdmin(tenantId);
      }

      match /settings/{settingId} {
          allow read: if isTenantMember(tenantId);
          allow write: if isTenantAdmin(tenantId);
      }

      // New rule for the usage ledger
      match /usage_ledger/{entryId} {
        // Only the backend can create usage entries
        allow create: if isTenantMember(tenantId); 
        // Only Super Admins should be able to read/modify the full ledger for auditing
        allow read, update, delete: if isSuperAdmin();
      }
    }
  }
}
