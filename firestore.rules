
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user belongs to a specific tenant
    function isUserOfTenant(tenantId) {
      return exists(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid));
    }
    
    // Tenants can only be read by users who belong to them. Creation/deletion is admin-only.
    match /tenants/{tenantId} {
      allow read: if isUserOfTenant(tenantId);
      allow write: if false; // Lock down for now, managed by backend/admin SDK

      // Users sub-collection
      match /users/{userId} {
        allow read: if isUserOfTenant(tenantId);
        // A user can update their own document, or an admin of the tenant can.
        allow write: if request.auth.uid == userId || get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }

      // Proposals sub-collection
      match /proposals/{proposalId} {
        // Allow read/write if the user is part of the tenant.
        // More granular rules can be added (e.g., only salesAgent can edit).
        allow read, write: if isUserOfTenant(tenantId);
        
        // Comments sub-collection within a proposal
        match /comments/{commentId} {
          allow read, create: if isUserOfTenant(tenantId);
          // Only the author can update/delete their own comment
          allow update, delete: if isUserOfTenant(tenantId) && resource.data.authorId == request.auth.uid;
        }

        // Suggested Edits sub-collection
        match /suggested_edits/{editId} {
            allow read, create: if isUserOfTenant(tenantId);
            // Only the sales agent who owns the proposal can update (accept/reject)
            allow update: if isUserOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/proposals/$(proposalId)).data.salesAgentId == request.auth.uid;
        }
      }

      // Products, Rules, Brand Assets, Legal Docs can be read by any user of the tenant.
      // Write access should be restricted to tenant admins.
      match /{subcollection}/{docId} {
        allow read: if isUserOfTenant(tenantId);
        allow write: if isUserOfTenant(tenantId) && get(/databases/$(database)/documents/tenants/$(tenantId)/users/$(request.auth.uid)).data.role == 'admin';
      }
    }
  }
}
