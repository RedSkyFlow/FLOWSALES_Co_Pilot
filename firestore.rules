rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Default: Deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // Tenant-based security structure
    match /tenants/{tenantId} {

      // Tenant document itself (can add rules for tenant admins later)
      allow read, write: if false;

      // Proposals: Only the assigned sales agent can read or write.
      match /proposals/{proposalId} {
        allow read, write: if request.auth.uid == resource.data.salesAgentId;

        // Comments & Edits: Users can read, but only authenticated users can create.
        match /comments/{commentId} {
            allow read: if true;
            allow create: if request.auth != null;
        }
        match /suggested_edits/{editId} {
            allow read: if true;
            allow create: if request.auth != null;
            // Only the sales agent can update (accept/reject)
            allow update: if get(/databases/$(database)/documents/tenants/$(tenantId)/proposals/$(proposalId)).data.salesAgentId == request.auth.uid;
        }
      }

      // Clients: Any authenticated user within the tenant can read.
      // Only admins or assigned agents should write. (NEEDS MORE SPECIFIC RULES)
      match /clients/{clientId} {
        allow read: if request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        allow write: if false; // Placeholder: Needs admin/role check
      }

      // Templates: Authenticated users can read.
      // Only admins should write. (NEEDS MORE SPECIFIC RULES)
      match /proposal_templates/{templateId} {
        allow read: if request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
        allow write: if false; // Placeholder: Needs admin role check
      }
      
      // Products: Authenticated users can read.
      // Only admins should write. (NEEDS MORE SPECIFIC RULES)
      match /products/{productId} {
         allow read: if request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.tenantId == tenantId;
         allow write: if false; // Placeholder: Needs admin role check
      }
    }
    
    // Users: A user can read/write their own document.
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }
  }
}
