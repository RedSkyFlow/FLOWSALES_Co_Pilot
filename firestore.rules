
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions that read directly from the user's auth token
    function isSuperAdmin() {
      return request.auth.token.role == 'super_admin';
    }
    
    function isTenantMember(tenantId) {
      return request.auth.token.tenantId == tenantId;
    }
    
    function isTenantAdmin(tenantId) {
      return isTenantMember(tenantId) && request.auth.token.role == 'admin';
    }

    // Users collection: Simple rules for user profile management
    match /users/{userId} {
      // A user document can be created if the user is authenticated, 
      // which is handled by the inviteUser admin function.
      allow create: if request.auth != null;
      // Users can only read/write their own user document
      allow read, update: if request.auth.uid == userId || isSuperAdmin();
    }
    
    // Tenants collection: The root for all tenant-specific data
    match /tenants/{tenantId} {
      // Only super admins can create or delete entire tenants
      allow create, delete: if isSuperAdmin();
      
      // Tenant members can read their own tenant doc, but only super admins can update subscription details etc.
      allow read: if isTenantMember(tenantId);
      allow update: if isSuperAdmin();

      // All sub-collections within a tenant require the user to be a member of that tenant
      match /{subcollection}/{docId} {
        allow read, write: if isTenantMember(tenantId);
      }
      
      // Specific rules for proposals sub-collection
      match /proposals/{proposalId} {
        // Any tenant member can read any proposal within their tenant
        allow read: if isTenantMember(tenantId);
        
        // Creating proposals is allowed for tenant members
        allow create: if isTenantMember(tenantId);
        
        // Updates are more complex:
        // - A sales agent can update a proposal they own.
        // - A tenant admin can update any proposal in their tenant.
        // - A client user can also update (e.g. to accept/sign)
        allow update: if isTenantMember(tenantId) && 
                         (resource.data.salesAgentId == request.auth.uid || 
                          isTenantAdmin(tenantId) ||
                          request.auth.token.role == 'client');
        
        // Deleting proposals is restricted to tenant admins or the sales agent who owns it.
        allow delete: if isTenantMember(tenantId) &&
                         (resource.data.salesAgentId == request.auth.uid ||
                          isTenantAdmin(tenantId));
      }

      // Rules for sub-sub-collections like comments, versions etc.
      match /proposals/{proposalId}/{subcollection}/{docId} {
         // Anyone who is a member of the tenant OR a client for that tenant can interact here
         // This is important for the public proposal view
         allow read, write: if isTenantMember(tenantId) || request.auth.token.role == 'client';
      }

      // Rules for product catalog, rules, etc.
      // Admins can write, members can only read
      match /products/{productId} {
          allow read: if isTenantMember(tenantId);
          allow write: if isTenantAdmin(tenantId);
      }
      
      match /product_rules/{ruleId} {
          allow read: if isTenantMember(tenantId);
          allow write: if isTenantAdmin(tenantId);
      }

      match /settings/{settingId} {
          allow read: if isTenantMember(tenantId);
          allow write: if isTenantAdmin(tenantId);
      }

      // Rules for the usage ledger
      match /usage_ledger/{entryId} {
        // Backend (with admin privileges) can create entries. The check for tenant membership is sufficient.
        allow create: if isTenantMember(tenantId); 
        // Only Super Admins should be able to read/modify the full ledger for auditing
        allow read, update, delete: if isSuperAdmin();
      }
    }
  }
}
